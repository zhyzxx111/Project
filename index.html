<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç²¤æ¸¯æ¾³æ–‡åŒ–æ´»åœ°å›¾</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"> </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: grid; grid-template-columns: 340px 1fr; height: 100%; }
    #sidebar { background: #111827; color: #e5e7eb; padding: 16px 16px 8px; overflow: auto; border-right: 1px solid #1f2937; }
    #map { height: 100%; width: 100%; position: relative; }
    .brand { font-weight: 800; margin-bottom: 8px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #111; border: 1px solid #333; font-size: 12px; margin-right: 6px; }
    fieldset { border: 1px solid #374151; border-radius: 12px; padding: 10px 12px; margin: 12px 0; }
    legend { padding: 0 6px; color: #9ca3af; }

    .control-row { display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap; align-items: center; }
    .btn { padding: 8px 10px; border: 1px solid #374151; background: #0b1220; color: #e5e7eb; border-radius: 10px; cursor: pointer; font-size: 12px; }
    .input { padding: 8px 10px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; border-radius:10px; font-size:14px; width:100%; }

    .tag { font-size: 12px; padding: 2px 6px; border-radius: 6px; background: #0f172a; border: 1px solid #1f2937; color: #cbd5e1; }
    .legend { display:flex; gap:8px; flex-wrap:wrap; margin-top: 6px; }

    .video-wrapper { position: relative; width: 100%; padding-bottom: 56.25%; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb22; }
    .video-wrapper iframe { position: absolute; width: 100%; height: 100%; left:0; top:0; border:0; }

    /* ğŸ”¥ ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼Œé¿å…ä¾§è¾¹æ æŒ¡ä½åœ°å›¾æ§ä»¶ */
    #burger{position:absolute;z-index:1000;top:12px;left:12px;background:#111827;color:#e5e7eb;border:1px solid #1f2937;padding:8px 10px;border-radius:10px;display:none;}

    @media (max-width:900px){
      #app{ grid-template-columns:1fr; }

      #sidebar{
        position:absolute;
        z-index:1001;
        width:300px;
        max-width:85vw;
        height:100%;
        transform: translateX(-100%);
        transition: transform .25s ease;
        box-shadow: 0 10px 30px rgba(0,0,0,.35);
      }

      #sidebar.open{ transform: translateX(0); }

      #burger{ display:block; }
    }
  </style>
</head>

<body>
  <div id="app">
    <aside id="sidebar">

      <button id="sidebarClose" style="
        background:#0f172a;
        border:1px solid #1f2937;
        color:white;
        border-radius:8px;
        padding:6px 10px;
        margin-bottom:10px;
        cursor:pointer;
        font-size:14px;
      ">å…³é—­ Ã—</button>

      <div class="brand">ç²¤æ¸¯æ¾³æ–‡åŒ–æ´»åœ°å›¾</div>

      <fieldset>
        <legend>æœç´¢</legend>
        <div class="control-row"><input id="searchInput" class="input" placeholder="æœç´¢æ ‡é¢˜æˆ–æ ‡ç­¾..." /></div>
      </fieldset>

      <fieldset>
        <legend>åˆ†ç±»ç­›é€‰</legend>
        <div id="catContainer" class="control-row"></div>
      </fieldset>

      <fieldset>
        <legend>åŠŸèƒ½</legend>
        <div class="control-row">
          <button id="btnFit" class="btn">ç¼©æ”¾åˆ°å…¨éƒ¨ç‚¹ä½</button>
          <button id="btnReset" class="btn">é‡ç½®ç­›é€‰</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>æµåŠ¨è·¯å¾„ï¼ˆå¯å•ç‹¬å¼€å…³ï¼‰</legend>
        <div id="flowList" class="control-row" style="flex-direction:column; align-items:flex-start;"></div>
        <button id="btnReplayFlows" class="btn">é‡æ–°æ’­æ”¾</button>
      </fieldset>

      <div class="legend" id="legend"></div>
    </aside>

    <div id="map"></div>
  </div>

  <button id="burger">â˜°</button>

<script>
/* =================== SUPABASE è¯„è®ºç³»ç»Ÿ =================== */

const SB_URL = 'https://dddgcpltndyfxlnaftnd.supabase.co';
const SB_KEY = 'ä½ çš„å®Œæ•´ Supabase key å¡«è¿™é‡Œ';

/* å–è¯„è®º */
async function getComments(pid){
  const res = await fetch(
    `${SB_URL}/rest/v1/comments?select=nick,text,imgs,created_at&place_id=eq.${encodeURIComponent(pid)}&order=created_at.desc`,
    { headers:{apikey:SB_KEY, Authorization:`Bearer ${SB_KEY}`} }
  );
  return await res.json();
}

/* å†™è¯„è®º */
async function addComment(data){
  await fetch(`${SB_URL}/rest/v1/comments`,{
    method:"POST",
    headers:{
      apikey:SB_KEY,
      Authorization:`Bearer ${SB_KEY}`,
      "Content-Type":"application/json",
      Prefer:"return=minimal"
    },
    body: JSON.stringify(data)
  });
}

/* =========== å·¥å…·å‡½æ•° =========== */
const iconMap = {é¥®é£Ÿ:"ğŸœ",èŠ‚åº†:"ğŸ",è¯­è¨€:"ğŸˆ¶",ç”Ÿæ´»æ–¹å¼:"ğŸ™ï¸",éé—è‰ºæœ¯:"ğŸª­",å»ºç­‘è®°å¿†:"ğŸ¯"};
const escapeHTML = (s='')=>s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

function emojiIcon(e){ return L.divIcon({html:`<div style="font-size:20px">${e}</div>`, className:"emoji-icon", iconSize:[24,24], iconAnchor:[12,24]}); }

/* place å”¯ä¸€ ID */
function placeId(p){
  const base=(p.title||"")+"|"+(Array.isArray(p.coords)?p.coords.join(","):"");
  let h=0; for(let i=0;i<base.length;i++){ h=((h<<5)-h)+base.charCodeAt(i); h|=0; }
  return "p"+(h>>>0);
}

/* å‹ç¼©å›¾ç‰‡ï¼ˆç”¨äºè¯„è®ºä¸Šä¼ ï¼‰ */
async function compressImage(file,maxSide=1024,quality=0.8){
  const img = await new Promise((res,rej)=>{
    const url=URL.createObjectURL(file);
    const i=new Image();
    i.onload=()=>{res(i); URL.revokeObjectURL(url);};
    i.onerror=rej;
    i.src=url;
  });
  let {width:w, height:h} = img;
  let tw=w, th=h;
  if(Math.max(w,h)>maxSide){
    if(w>h){ tw=maxSide; th=Math.round(h*maxSide/w); }
    else{ th=maxSide; tw=Math.round(w*maxSide/h); }
  }
  const canvas=document.createElement("canvas");
  canvas.width=tw; canvas.height=th;
  canvas.getContext("2d").drawImage(img,0,0,tw,th);
  return canvas.toDataURL("image/jpeg", quality);
}

/* ============ æ¸²æŸ“è¯„è®ºå¼¹çª— ============ */
function buildPopupDOM(p){
  const wrap=document.createElement("div");
  wrap.className="popup";
  wrap.innerHTML = `<h3>${escapeHTML(p.title)}</h3><p>${escapeHTML(p.description||'')}</p>`;

  /* æ ‡ç­¾ */
  if(p.tags?.length){
    const tagBox=document.createElement("div");
    p.tags.forEach(t=>{
      const el=document.createElement("span");
      el.className="tag";
      el.textContent="#"+t;
      tagBox.appendChild(el);
    });
    wrap.appendChild(tagBox);
  }

  /* è¯„è®ºåŒºå®¹å™¨ */
  const cwrap=document.createElement("div");
  cwrap.className="cmt-wrap";
  cwrap.innerHTML=`<div class="cmt-title">è¯„è®ºåŒº</div>
                   <div class="cmt-list"></div>`;
  wrap.appendChild(cwrap);

  const listBox=cwrap.querySelector(".cmt-list");
  const pid=placeId(p);

  /* åŠ è½½è¯„è®º */
  async function loadList(){
    listBox.innerHTML="åŠ è½½ä¸­...";
    const arr=await getComments(pid);
    listBox.innerHTML="";
    if(!arr.length){
      listBox.innerHTML=`<div style="color:#94a3b8">è¿˜æ²¡æœ‰è¯„è®ºï½</div>`;
      return;
    }
    arr.forEach(cm=>{
      const item=document.createElement("div");
      item.className="cmt-item";
      item.innerHTML=`<div class="cmt-meta">
                        <span>${escapeHTML(cm.nick||"åŒ¿å")}</span>
                        <span>${new Date(cm.created_at).toLocaleString()}</span>
                      </div>
                      <div class="cmt-text">${escapeHTML(cm.text||"")}</div>`;
      if(cm.imgs?.length){
        const box=document.createElement("div");
        box.className="cmt-imgs";
        cm.imgs.forEach(src=>{
          const im=document.createElement("img");
          im.src=src;
          box.appendChild(im);
        });
        item.appendChild(box);
      }
      listBox.appendChild(item);
    });
  }
  loadList();

  /* å‘è¡¨è¯„è®º UI */
  const form=document.createElement("div");
  form.className="cmt-form";
  form.innerHTML=`
    <input type="text" placeholder="æ˜µç§°ï¼ˆå¯é€‰ï¼‰">
    <textarea rows="3" placeholder="å†™ç‚¹ä»€ä¹ˆâ€¦"></textarea>
    <input type="file" accept="image/*" multiple>
    <button class="btn primary">å‘è¡¨</button>
  `;
  cwrap.appendChild(form);

  const nick=form.children[0];
  const text=form.children[1];
  const file=form.children[2];
  const btn=form.children[3];

  btn.onclick=async()=>{
    const content=text.value.trim();
    const files=Array.from(file.files||[]);
    if(!content && !files.length){ alert("å†™ç‚¹å†…å®¹æˆ–å›¾ç‰‡å§"); return; }

    const imgs=[];
    for(const f of files){
      const data=await compressImage(f);
      imgs.push(data);
    }
    await addComment({place_id:pid, nick:nick.value, text:content, imgs});
    text.value=""; file.value="";
    loadList();
  };

  return wrap;
}

/* ============ Marker åˆ†ç±»ä¸æ¸²æŸ“ ============ */
const layerGroups=new Map();
const placesState={ places:[], categories:new Set() };

function renderCategoryControls(){
  const container=document.getElementById("catContainer");
  const legend=document.getElementById("legend");
  container.innerHTML=""; legend.innerHTML="";

  placesState.categories.forEach(cat=>{
    const id=`cat_${cat}`;
    const label=document.createElement("label");
    label.innerHTML=`<input type="checkbox" class="cat-check" id="${id}" value="${cat}" checked> ${cat}`;
    container.appendChild(label);

    const chip=document.createElement("div");
    chip.className="chip";
    chip.innerHTML=`<span>${iconMap[cat]||"ğŸ“"}</span>${cat}`;
    legend.appendChild(chip);
  });

  document.querySelectorAll(".cat-check").forEach(c=>c.addEventListener("change",applyFilter));
}

function rebuildMarkers(list){
  /* æ¸…é™¤æ—§å›¾å±‚ */
  layerGroups.forEach(g=>map.removeLayer(g));
  layerGroups.clear();

  placesState.categories.forEach(cat=>{
    layerGroups.set(cat, L.markerClusterGroup());
  });

  /* æ–° markers */
  list.forEach(p=>{
    const m=L.marker(p.coords,{icon:emojiIcon(iconMap[p.category]||"ğŸ“")});
    m.bindPopup(buildPopupDOM(p), {maxWidth:420});
    layerGroups.get(p.category).addLayer(m);
  });

  /* åŠ å…¥åœ°å›¾ */
  layerGroups.forEach(g=>g.addTo(map));
}

function applyFilter(){
  const checks=[...document.querySelectorAll(".cat-check")];
  const enabled=new Set(checks.filter(c=>c.checked).map(c=>c.value));

  const q=document.getElementById("searchInput").value.trim().toLowerCase();

  const filtered=placesState.places.filter(p=>{
    if(!enabled.has(p.category)) return false;
    if(!q) return true;
    return (p.title||"").toLowerCase().includes(q)
        || (p.tags||[]).join(",").toLowerCase().includes(q);
  });

  rebuildMarkers(filtered);
  fitAll();
}

function fitAll(){
  const layers=[...layerGroups.values()].flatMap(g=>g.getLayers());
  const flowPolys=flowLayers.map(o=>o.polyline);
  const flowDots=flowLayers.map(o=>o.dot);
  const fg=L.featureGroup([...layers,...flowPolys,...flowDots]);
  map.fitBounds(fg.getBounds().pad(0.2));
}

/* ========== åˆå§‹åŒ–åœ°å›¾ =========== */
const map=L.map("map",{ center:[22.9,113.5], zoom:9, minZoom:3 });

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"Â© OpenStreetMap contributors"
}).addTo(map);

/* å·¦ä¸Šè§’èœå•æŒ‰é’® */
document.getElementById("burger").onclick=()=>{
  document.getElementById("sidebar").classList.toggle("open");
};

document.getElementById("sidebarClose").onclick=()=>{
  document.getElementById("sidebar").classList.remove("open");
};
/* =================== æµåŠ¨è·¯å¾„ï¼ˆFlow Linesï¼‰ =================== */

const flowLayers=[];
let flowAnimRunning=false;

/* æ¸…ç©ºæ‰€æœ‰æµåŠ¨çº¿å±‚ */
function clearFlows(){
  flowLayers.forEach(o=>{
    if(o.polyline) map.removeLayer(o.polyline);
    if(o.dot) map.removeLayer(o.dot);
  });
  flowLayers.length=0;
}

/* ç”ŸæˆæµåŠ¨çº¿è·¯ */
function buildFlows(flows){
  clearFlows();
  if(!flows || !flows.length) return;

  flows.forEach(f=>{
    const c=f.coords||[];
    if(c.length<2) return;

    const color=f.color||"#2563eb";

    const poly=L.polyline(c,{
      color,
      weight:3,
      opacity:0.9,
      dashArray:"6 8"
    }).addTo(map);

    const dot=L.circleMarker(c[0],{
      radius:5,
      color,
      weight:2,
      fillOpacity:1
    }).addTo(map);

    flowLayers.push({
      name:f.name,
      coords:c,
      color,
      polyline:poly,
      dot,
      idx:0,
      phase:0,
      speed:(f.speed||0.006)
    });
  });

  startFlowAnimation();
}

/* æ’­æ”¾åŠ¨ç”» */
function startFlowAnimation(){
  flowAnimRunning=true;
  const step=()=>{
    if(!flowAnimRunning) return;
    flowLayers.forEach(o=>{
      const a=o.coords[o.idx], b=o.coords[o.idx+1];
      if(!b){ o.idx=0; o.phase=0; return; }

      o.phase+=o.speed;
      if(o.phase>=1){ o.phase=0; o.idx++; }

      const lat=a[0]+(b[0]-a[0])*o.phase;
      const lng=a[1]+(b[1]-a[1])*o.phase;
      o.dot.setLatLng([lat,lng]);
    });
    requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

function stopFlowAnimation(){ flowAnimRunning=false; }

/* é‡æ–°æ’­æ”¾æŒ‰é’® */
document.getElementById("btnReplayFlows").onclick=()=>{
  flowLayers.forEach(o=>{
    o.idx=0;
    o.phase=0;
    o.dot.setLatLng(o.coords[0]);
  });
};

/* =================== å•ç‹¬æ§åˆ¶æ¯æ¡ Flow ON/OFF =================== */

function renderFlowControls(flows){
  const box=document.getElementById("flowList");
  box.innerHTML="";

  flows.forEach((f,idx)=>{
    const id="flow_chk_"+idx;
    const lbl=document.createElement("label");
    lbl.style.display="flex";
    lbl.style.alignItems="center";
    lbl.style.gap="6px";

    lbl.innerHTML=`
      <input type="checkbox" id="${id}" data-flow="${idx}" checked>
      ${f.name}
    `;
    box.appendChild(lbl);

    document.getElementById(id).onchange=e=>{
      const i=parseInt(e.target.dataset.flow);
      const on=e.target.checked;
      const o=flowLayers[i];
      if(!o) return;

      if(on){
        if(!map.hasLayer(o.polyline)) o.polyline.addTo(map);
        if(!map.hasLayer(o.dot)) o.dot.addTo(map);
      }else{
        if(map.hasLayer(o.polyline)) map.removeLayer(o.polyline);
        if(map.hasLayer(o.dot)) map.removeLayer(o.dot);
      }
    };
  });
}

/* =================== åŠ è½½ places.json =================== */

async function loadPlaces(){
  try{
    const res=await fetch("places.json?v="+Date.now(), {cache:"no-cache"});
    if(!res.ok) throw new Error("HTTP "+res.status);

    const json=await res.json();

    const places = Array.isArray(json.places) ? json.places : [];
    const flows  = Array.isArray(json.flows)  ? json.flows  : [];

    /* ä¿å­˜çŠ¶æ€ */
    placesState.places=places;
    placesState.categories=new Set(places.map(p=>p.category));

    renderCategoryControls();
    rebuildMarkers(places);

    buildFlows(flows);
    renderFlowControls(flows);

    fitAll();

  }catch(e){
    console.warn("åŠ è½½ places.json å¤±è´¥", e);
  }
}

/* =================== å¯åŠ¨ç¨‹åº =================== */

loadPlaces();

/* ç‚¹å‡»åœ°å›¾æ—¶è‡ªåŠ¨æ”¶å›ä¾§è¾¹æ ï¼ˆæ‰‹æœºç«¯ï¼‰ */
map.on("click",()=>{
  if(window.innerWidth < 900){
    document.getElementById("sidebar").classList.remove("open");
  }
});

</script>
</body>
</html>
