<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç²¤æ¸¯æ¾³æ–‡åŒ–æ´»åœ°å›¾</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"> </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: grid; grid-template-columns: 340px 1fr; height: 100%; }
    #sidebar { background: #111827; color: #e5e7eb; padding: 16px 16px 8px; overflow: auto; border-right: 1px solid #1f2937; }
    #map { height: 100%; width: 100%; position: relative; }
    .brand { font-weight: 800; margin-bottom: 8px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #111; border: 1px solid #333; font-size: 12px; margin-right: 6px; }
    fieldset { border: 1px solid #374151; border-radius: 12px; padding: 10px 12px; margin: 12px 0; }
    legend { padding: 0 6px; color: #9ca3af; }
    .control-row { display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap; align-items: center; }
    .btn { padding: 8px 10px; border: 1px solid #374151; background: #0b1220; color: #e5e7eb; border-radius: 10px; cursor: pointer; font-size: 12px; }
    .input { padding: 8px 10px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; border-radius:10px; font-size:14px; width:100%; }
    .tag { font-size: 12px; padding: 2px 6px; border-radius: 6px; background: #0f172a; border: 1px solid #1f2937; color: #cbd5e1; }
    .legend { display:flex; gap:8px; flex-wrap:wrap; margin-top: 6px; }
    .video-wrapper { position: relative; width: 100%; padding-bottom: 56.25%; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb22; }
    .video-wrapper iframe { position: absolute; width: 100%; height: 100%; left:0; top:0; border:0; }

    #burger{position:absolute;z-index:1000;top:12px;left:12px;background:#111827;color:#e5e7eb;border:1px solid #1f2937;padding:8px 10px;border-radius:10px;display:none;}
    @media (max-width:900px){
      #app{ grid-template-columns:1fr; }
      #sidebar{ position:absolute; z-index:1001; width:min(92vw,420px); height:100%; transform: translateX(-100%); transition: transform .25s ease; box-shadow: 0 10px 30px rgba(0,0,0,.35);}
      #sidebar.open{ transform: translateX(0); }
      #burger{ display:block; }
    }
  </style>
</head>

<body>
  <div id="app">
    <aside id="sidebar">
      <div class="brand">ç²¤æ¸¯æ¾³æ–‡åŒ–æ´»åœ°å›¾</div>

      <fieldset>
        <legend>æœç´¢</legend>
        <div class="control-row"><input id="searchInput" class="input" placeholder="æœç´¢æ ‡é¢˜æˆ–æ ‡ç­¾..." /></div>
      </fieldset>

      <fieldset>
        <legend>åˆ†ç±»ç­›é€‰</legend>
        <div id="catContainer" class="control-row"></div>
      </fieldset>

      <fieldset>
        <legend>åŠŸèƒ½</legend>
        <div class="control-row">
          <button id="btnFit" class="btn">ç¼©æ”¾åˆ°å…¨éƒ¨ç‚¹ä½</button>
          <button id="btnReset" class="btn">é‡ç½®ç­›é€‰</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>æµåŠ¨è·¯å¾„ï¼ˆå¯å•ç‹¬å¼€å…³ï¼‰</legend>
        <div id="flowList" class="control-row" style="flex-direction:column; align-items:flex-start;"></div>
        <button id="btnReplayFlows" class="btn">é‡æ–°æ’­æ”¾</button>
      </fieldset>

      <div class="legend" id="legend"></div>
    </aside>

    <div id="map"></div>
  </div>

  <button id="burger">â˜°</button>

  <script>
    const SB_URL = 'https://dddgcpltndyfxlnaftnd.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';

    const iconMap = { 'é¥®é£Ÿ':'ğŸœ', 'èŠ‚åº†':'ğŸ', 'è¯­è¨€':'ğŸˆ¶', 'ç”Ÿæ´»æ–¹å¼':'ğŸ™ï¸', 'éé—è‰ºæœ¯':'ğŸª­', 'å»ºç­‘è®°å¿†':'ğŸ¯' };
    const escapeHTML = (s='') => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    
    const flowLayers = [];
    let flowAnimRunning = false;

    function clearFlows() {
      flowLayers.forEach(o=>{
        if(o.polyline) map.removeLayer(o.polyline);
        if(o.dot) map.removeLayer(o.dot);
      });
      flowLayers.length = 0;
    }

    function buildFlows(flows){
      clearFlows();
      if(!flows || !flows.length) return;

      flows.forEach(f=>{
        const c=f.coords||[];
        if(c.length<2) return;

        const poly=L.polyline(c,{
          color:f.color||'#2563eb',
          weight:3,
          opacity:0.9,
          dashArray:'6 8'
        }).addTo(map);

        const dot=L.circleMarker(c[0],{
          radius:5, color:f.color||'#2563eb', weight:2, fillOpacity:1
        }).addTo(map);

        flowLayers.push({
          name:f.name||'flow',
          coords:c,
          color:f.color||'#2563eb',
          polyline:poly,
          dot, idx:0,
          phase:0,
          speed:(f.speed||0.006)
        });
      });

      startFlowAnimation();
    }

    function renderFlowControls(flows) {
      const box = document.getElementById("flowList");
      box.innerHTML = "";

      flows.forEach((f, idx) => {
        const id = "flow_chk_" + idx;

        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.gap = "6px";

        label.innerHTML = `
          <input type="checkbox" id="${id}" data-flow-index="${idx}" checked>
          ${f.name}
        `;

        box.appendChild(label);

        document.getElementById(id).addEventListener("change", (e) => {
          const i = parseInt(e.target.dataset.flowIndex);
          const on = e.target.checked;
          const o = flowLayers[i];
          if (!o) return;

          if (on) {
            if (!map.hasLayer(o.polyline)) o.polyline.addTo(map);
            if (!map.hasLayer(o.dot)) o.dot.addTo(map);
          } else {
            if (map.hasLayer(o.polyline)) map.removeLayer(o.polyline);
            if (map.hasLayer(o.dot)) map.removeLayer(o.dot);
          }
        });
      });
    }

    function startFlowAnimation(){
      flowAnimRunning = true;
      const step = () => {
        if (!flowAnimRunning) return;
        flowLayers.forEach(o=>{
          const a=o.coords[o.idx], b=o.coords[o.idx+1];
          if(!b){ o.idx=0; o.phase=0; return; }

          o.phase += o.speed;
          if(o.phase>=1){ o.phase=0; o.idx++; }

          const lat=a[0] + (b[0]-a[0])*o.phase;
          const lng=a[1] + (b[1]-a[1])*o.phase;
          o.dot.setLatLng([lat,lng]);
        });
        requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }
    function stopFlowAnimation(){ flowAnimRunning=false; }

    document.getElementById("btnReplayFlows").addEventListener("click",()=>{
      flowLayers.forEach(o=>{
        o.idx=0; o.phase=0;
        o.dot.setLatLng(o.coords[0]);
      });
    });

    async function loadPlaces(){
      try{
        const res = await fetch('places.json?v='+Date.now(),{ cache:'no-cache' });
        const json = await res.json();

        let places = json.places || [];
        let flows = json.flows  || [];

        buildMarkers(places);
        buildFlows(flows);
        renderFlowControls(flows);
        fitAll();

      }catch(e){
        console.warn("åŠ è½½ places.json å¤±è´¥", e);
      }
    }

    /*****************************************************************/

    loadPlaces();

  </script>
</body>
</html>
